package controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import dao.AccDao;
import dao.AdminDao;
import dao.InquireDao;
import dao.MyInformationDao;
import model.AccUpdate;
import model.Accommodation;
import model.Inquire;
import model.LoginUser;
import model.Reservation;
import model.Room;
import model.RoomCompareDTO;
import model.RoomUpdate;
import model.StartEnd;
import model.UserInfo;

@Controller
public class AdminController {
    
    @Autowired
    private AdminDao adminDao;
    @Autowired
    private MyInformationDao myinformationDao;
    @Autowired
    private InquireDao inquireDao;
    @Autowired
    private AccDao accDao;
    
    @RequestMapping(value="/admin/rejectAccUpdate.html") //ìˆ™ì†Œ ìˆ˜ì • ì‹ ì²­ ê±°ì ˆ
    public ModelAndView rejectAccUpdate(String acc_request_id, RedirectAttributes redirectAttributes) {
    	AccUpdate accUpdate = this.accDao.getAccUpdate(Integer.parseInt(acc_request_id));
    	accUpdate.setAcc_approval_status("ìŠ¹ì¸ê±°ì ˆ");
    	this.accDao.updateAccUpdate(accUpdate);
    	
    	List<RoomUpdate> roomUpdate = this.accDao.getRoomUpdateList(Integer.parseInt(acc_request_id));
    	for(RoomUpdate r : roomUpdate) {
    		r.setRoom_approval_status("ìŠ¹ì¸ê±°ì ˆ");
    		this.accDao.updateRoomUpdate(r);
    	}
    	
    	redirectAttributes.addFlashAttribute("msg", "ìˆ™ì†Œ ìˆ˜ì • ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
    	redirectAttributes.addFlashAttribute("msgType", "rejecy");
    	
    	return new ModelAndView("redirect:/admin/adminAccAccept.html");
    }
    
    @RequestMapping(value="/admin/approveAccUpdate.html") //ìˆ™ì†Œ ìˆ˜ì • ì‹ ì²­ ìŠ¹ì¸
    public ModelAndView approveAccUpdate(String acc_request_id, RedirectAttributes redirectAttributes) {
    	AccUpdate accUpdate = this.accDao.getAccUpdate(Integer.parseInt(acc_request_id));
    	accUpdate.setAcc_approval_status("ìŠ¹ì¸ì™„ë£Œ");
    	List<RoomUpdate> roomUpdate = this.accDao.getRoomUpdateList(Integer.parseInt(acc_request_id));
    	
    	//ìˆ™ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸
    	this.accDao.updateAccUpdate(accUpdate); //dbì—ì„œ ìŠ¹ì¸ìƒíƒœë¥¼ ì™„ë£Œë¡œ ì—…ë°ì´íŠ¸
    	this.accDao.updateAcc(accUpdate); //dbì—ì„œ ìˆ™ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸
    	
    	//ê°ì‹¤ ì •ë³´ ì—…ë°ì´íŠ¸
    	for(RoomUpdate r : roomUpdate) {
    		r.setRoom_approval_status("ìŠ¹ì¸ì™„ë£Œ");
    		this.accDao.updateRoomUpdate(r);
    		this.accDao.updateRoom(r);
    	}
    	
//    	//ê°ì‹¤ ìˆ˜ì •ì‚¬í•­ ì‚­ì œ
//    	List<Integer> roomReqId = this.accDao.getRoomReqIdList(Integer.parseInt(acc_request_id));
//    	for(Integer i : roomReqId) {
//    		this.accDao.deleteRoomRequest(i);
//    	}
//    	//ìŠ¥ì†Œ ìˆ˜ì •ì‚¬í•­ ì‚­ì œ
//    	this.accDao.deleteAccRequest(Integer.parseInt(acc_request_id));
    	
    	redirectAttributes.addFlashAttribute("msg", "ìˆ™ì†Œ ìˆ˜ì • ìš”ì²­ì„ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤.");
    	redirectAttributes.addFlashAttribute("msgType", "success");

    	return new ModelAndView("redirect:/admin/adminAccAccept.html");
    }
    
    @RequestMapping(value="/admin/adminAccApproveDetail.html")
    public ModelAndView adminAccApproveDetail(String accId, String accRequestId) {
    	ModelAndView mav = new ModelAndView("main");
    	Accommodation acc = this.accDao.getAccDetail(accId);
    	AccUpdate accUpdate = this.accDao.getAccUpdate(Integer.parseInt(accRequestId));
    	List<Room> roomList = this.accDao.getRoomList(accId);
		List<RoomUpdate> roomUpdateList  = this.accDao.getRoomUpdateList(accUpdate.getAcc_request_id());
		
		// 1. room_idë¡œ ë°© ìˆ˜ì • ìš”ì²­ ë§¤í•‘
		Map<String, RoomUpdate> updateRoomMap = new HashMap<>();
		for (RoomUpdate update : roomUpdateList) {
		    updateRoomMap.put(update.getRoom().getId().getRoomId(), update); // room_idë¡œ ë§¤í•‘
		}

		// 2. roomList ìˆœì„œëŒ€ë¡œ RoomCompareDTO ìƒì„±
		List<RoomCompareDTO> roomCompareList = new ArrayList<>();
		for (Room room : roomList) {
		    RoomUpdate update = updateRoomMap.get(room.getId().getRoomId()); // room_id ê¸°ì¤€ ë§¤ì¹­
		    roomCompareList.add(new RoomCompareDTO(room, update)); // ì—†ìœ¼ë©´ nullë¡œ ë“¤ì–´ê°
		}
    	
		mav.addObject("roomCompareList", roomCompareList);
    	mav.addObject("acc", acc);
    	mav.addObject("accUpdate", accUpdate);
    	mav.addObject("BODY","adminAccApproveDetail.jsp");
    	return mav;
    }
    
    @RequestMapping(value="/admin/adminAccAcceptDetail.html")
    public ModelAndView AccAcceptDetail(String accId, String accRequestId) {
    	ModelAndView mav = new ModelAndView("main");
    	Accommodation acc = this.accDao.getAccDetail(accId);
    	AccUpdate accUpdate = this.accDao.getAccUpdate(Integer.parseInt(accRequestId));
    	List<Room> roomList = this.accDao.getRoomList(accId);
		List<RoomUpdate> roomUpdateList  = this.accDao.getRoomUpdateList(accUpdate.getAcc_request_id());
		
		// 1. room_idë¡œ ë°© ìˆ˜ì • ìš”ì²­ ë§¤í•‘
		Map<String, RoomUpdate> updateRoomMap = new HashMap<>();
		for (RoomUpdate update : roomUpdateList) {
		    updateRoomMap.put(update.getRoom().getId().getRoomId(), update); // room_idë¡œ ë§¤í•‘
		}

		// 2. roomList ìˆœì„œëŒ€ë¡œ RoomCompareDTO ìƒì„±
		List<RoomCompareDTO> roomCompareList = new ArrayList<>();
		for (Room room : roomList) {
		    RoomUpdate update = updateRoomMap.get(room.getId().getRoomId()); // room_id ê¸°ì¤€ ë§¤ì¹­
		    roomCompareList.add(new RoomCompareDTO(room, update)); // ì—†ìœ¼ë©´ nullë¡œ ë“¤ì–´ê°
		}
    	
		mav.addObject("roomCompareList", roomCompareList);
    	mav.addObject("acc", acc);
    	mav.addObject("accUpdate", accUpdate);
    	mav.addObject("BODY","adminAccAcceptDetail.jsp");
    	return mav;
    }
    
    @RequestMapping(value="/admin/adminAccAccept.html") //ìˆ™ì†Œ ì •ë³´ ìˆ˜ì • ìŠ¹ì¸ ë¦¬ìŠ¤íŠ¸
    public ModelAndView adminUpdate() {
    	ModelAndView mav = new ModelAndView("main");
    	List<AccUpdate> accUpdateList = this.accDao.getAccUpdateList(); //ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸
    	 
    	mav.addObject("accUpdateList", accUpdateList);
    	mav.addObject("BODY","adminAccAccept.jsp");
    	return mav;
    }
    @RequestMapping(value="/admin/adminAccAcceptByAdmin.html") //ìˆ™ì†Œ ì •ë³´ ìˆ˜ì • ìŠ¹ì¸ ë¦¬ìŠ¤íŠ¸
    public ModelAndView adminUpdateByAdmin(String userId) {
    	ModelAndView mav = new ModelAndView("main");
    	List<AccUpdate> accUpdateList = this.accDao.getAccUpdateListByUser(userId);
    	
    	mav.addObject("accUpdateList", accUpdateList);
    	mav.addObject("BODY","adminAccAccept.jsp");
    	return mav;
    }
    
    @RequestMapping("/admin/userInqList.html")
    public ModelAndView userInqList(HttpSession session, String userId, Integer pageNo) {
    	ModelAndView mav = new ModelAndView("main");
    	LoginUser loginUser = (LoginUser)session.getAttribute("loginUser");
    	//ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
        if (loginUser == null || !"admin".equals(loginUser.getId())) {
            mav.addObject("BODY","login.jsp");
            mav.addObject(new LoginUser());
            return mav;
        }

    	int currentPage = 1;
    	if(pageNo != null) currentPage = pageNo;
    	int start =(currentPage-1) * 4;
    	int end = ((currentPage-1)*4)+5;
    	StartEnd se = new StartEnd();se.setStart(start);se.setEnd(end); se.setUserId(userId);  // ğŸ”¥ ì¶”ê°€: í˜„ì¬ ë¡œê·¸ì¸í•œ user_idë¥¼ í•„í„°ë§ ì¡°ê±´ìœ¼ë¡œ ì „ë‹¬
    	List<Inquire> inquireList;
        if ("admin".equals(userId)) {
            // ğŸ”¥ adminì€ ëª¨ë“  ë¬¸ì˜ ì¡°íšŒ
            inquireList = this.inquireDao.getInquireList(se);
        } else {
            // ğŸ”¥ ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ ë¬¸ì˜ + adminì´ ì‘ì„±í•œ ë¬¸ì˜ë§Œ ì¡°íšŒ
            inquireList = this.inquireDao.getInquireListByUser(se);
        }
        int totalCount = "admin".equals(userId) ? this.inquireDao.getInquireCountAll() : this.inquireDao.getInquireCountUser(userId);
    	int pageCount = totalCount/4;
    	if(totalCount %4 !=0) pageCount++;
    	mav.addObject("currentPage",currentPage);
    	mav.addObject("PAGES",pageCount);
    	mav.addObject("BODY","inquireList.jsp");
    	mav.addObject("INQUIRE",inquireList);
    	return mav;
    }
    
    // ì‚¬ìš©ì ì¡°íšŒ-> ìŠ¹ì¸ ëŒ€ê¸° ìˆ™ì†Œ ëª©ë¡
    @RequestMapping("/admin/adminPendingAccByAdmin.html")
    public ModelAndView pendingAccommodationsByAdmin(HttpSession session, String userId) {
        ModelAndView mav = new ModelAndView("main");
    	LoginUser loginUser = (LoginUser)session.getAttribute("loginUser");
    	//ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
        if (loginUser == null || !"admin".equals(loginUser.getId())) {
            mav.addObject("BODY","login.jsp");
            mav.addObject(new LoginUser());
            return mav;
        }

        List<Map<String, Object>> accommodations = adminDao.getPendingAccommodationsByAdmin(userId);

        // accommodation_id ê°’ ê°•ì œ ì¶”ê°€
        for (Map<String, Object> acc : accommodations) {
            if (!acc.containsKey("accommodation_id")) {
                acc.put("accommodation_id", acc.get("ACCOMMODATION_ID"));
            }
        }
        mav.addObject("pendingAccommodations", accommodations);
        mav.addObject("BODY", "adminPendingAcc.jsp");
        return mav;
    }
    
    
    
    // ì‚¬ìš©ì ì¡°íšŒ -> ë“±ë¡ëœ ìˆ™ì†Œ ëª©ë¡ ì¡°íšŒ
    @RequestMapping("/admin/adminRegisteredAccByAdmin.html")
    public ModelAndView registeredAccommodationsByAdmin(HttpSession session, String userId) {
        ModelAndView mav = new ModelAndView("main");
    	LoginUser loginUser = (LoginUser)session.getAttribute("loginUser");
    	//ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
        if (loginUser == null || !"admin".equals(loginUser.getId())) {
            mav.addObject("BODY","login.jsp");
            mav.addObject(new LoginUser());
            return mav;
        }
        

        List<Map<String, Object>> accommodations = adminDao.getRegisteredAccommodationsByAdmin(userId);

        // accommodation_id ê°’ ê°•ì œ ì¶”ê°€
        for (Map<String, Object> acc : accommodations) {
            if (!acc.containsKey("accommodation_id")) {
                acc.put("accommodation_id", acc.get("ACCOMMODATION_ID"));
            }
        }
        mav.addObject("registeredAccommodations", accommodations);
        mav.addObject("BODY", "adminRegisteredAcc.jsp");
        return mav;
    }
    
    @RequestMapping("/admin/userReservList.html") //ì‚¬ìš©ì ì¡°íšŒ -> ì‚¬ìš©ì ì˜ˆì•½ëª©ë¡ ë¦¬ìŠ¤íŠ¸
    public ModelAndView userReservList(HttpSession session, String userId) {
    	ModelAndView mav = new ModelAndView("main");
    	LoginUser loginUser = (LoginUser)session.getAttribute("loginUser");
    	//ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
        if (loginUser == null || !"admin".equals(loginUser.getId())) {
            mav.addObject("BODY","login.jsp");
            mav.addObject(new LoginUser());
            return mav;
        }
        //ì‚¬ìš©ìì˜ ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸
        List<Reservation> reservList = this.myinformationDao.getReservList(userId);
        mav.addObject("reservList", reservList);
    	mav.addObject("BODY", "mypageAccList.jsp");
    	return mav;
    }
    
    // âœ… ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì´ë™
    @RequestMapping("/admin/adminUserManagement.html")
    public ModelAndView userManagement() {
        ModelAndView mav = new ModelAndView("main"); 
        mav.addObject("BODY", "adminUserManagement.jsp"); // BODYì— adminUserManagement.jsp ì„¤ì •
        return mav;
    }

    // âœ… ì‚¬ìš©ì ì¡°íšŒ í˜ì´ì§€ (í˜ì´ì§€ ì´ë™ ë° ì¡°íšŒ ê²°ê³¼ ì²˜ë¦¬)
    @RequestMapping("/admin/viewUserInfo.html")
    public ModelAndView viewUserInfo(@RequestParam(value = "user_id", required = false) String user_id) {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "adminViewUserInfo.jsp");

        if (user_id != null && !user_id.trim().isEmpty()) {
            UserInfo userInfo = adminDao.getUserInfoById(user_id.trim());
            
            if (userInfo != null) {
                mav.addObject("userInfo", userInfo); // ì¡°íšŒëœ ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
            } else {
                mav.addObject("error", "í•´ë‹¹ ì•„ì´ë””ì˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
                mav.addObject("BODY", "adminUserManagement.jsp");
            }
        } else {
            mav.addObject("error", "ì‚¬ìš©ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            mav.addObject("BODY", "adminUserManagement.jsp");
        }

        return mav;
    }
    
    // âœ… ë“±ë¡ëœ ìˆ™ì†Œ ëª©ë¡ ì¡°íšŒ
    @RequestMapping("/admin/adminRegisteredAcc.html")
    public ModelAndView registeredAccommodations() {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "adminRegisteredAcc.jsp");

        List<Map<String, Object>> accommodations = adminDao.getRegisteredAccommodations();

        // accommodation_id ê°’ ê°•ì œ ì¶”ê°€
        for (Map<String, Object> acc : accommodations) {
            if (!acc.containsKey("accommodation_id")) {
                acc.put("accommodation_id", acc.get("ACCOMMODATION_ID"));
            }
        }

        mav.addObject("registeredAccommodations", accommodations);
        return mav;
    }
    
    // âœ… ë“±ë¡ëœ ìˆ™ì†Œ ìƒì„¸ ì¡°íšŒ (app_status = 1ì¸ ìˆ™ì†Œë§Œ)
    @RequestMapping("/admin/viewRegisteredAccommodationDetail.html")
    public ModelAndView viewRegisteredAccommodationDetail(@RequestParam("accommodationId") String accommodationId) {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "registeredAccommodationDetail.jsp");

        if (accommodationId == null || accommodationId.trim().isEmpty()) {
            mav.addObject("error", "ìˆ™ì†Œ IDê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return mav;
        }

        Map<String, Object> accommodation = adminDao.getRegisteredAccommodationById(accommodationId.trim());
        List<Map<String, Object>> roomList = adminDao.getRoomsByAccommodationId(accommodationId.trim());

        if (accommodation == null || accommodation.isEmpty()) {
            mav.addObject("error", "í•´ë‹¹ ìˆ™ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            mav.addObject("accommodation", accommodation);
        }

        mav.addObject("rooms", roomList);

        return mav;
    }
    
    // âœ… ìŠ¹ì¸ ëŒ€ê¸° ìˆ™ì†Œ ëª©ë¡
    @RequestMapping("/admin/adminPendingAcc.html")
    public ModelAndView pendingAccommodations() {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "adminPendingAcc.jsp");

        List<Map<String, Object>> accommodations = adminDao.getPendingAccommodations();

        // accommodation_id ê°’ ê°•ì œ ì¶”ê°€
        for (Map<String, Object> acc : accommodations) {
            if (!acc.containsKey("accommodation_id")) {
                acc.put("accommodation_id", acc.get("ACCOMMODATION_ID"));
            }
        }

        mav.addObject("pendingAccommodations", accommodations);
        return mav;
    }

    // âœ… ìˆ™ì†Œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
    @RequestMapping("/admin/viewAccommodationDetail.html")
    public ModelAndView viewAccommodationDetail(@RequestParam("accommodationId") String accommodationId) {
        ModelAndView mav = new ModelAndView("main");  
        mav.addObject("BODY", "approveAccommodation.jsp");  

        if (accommodationId == null || accommodationId.trim().isEmpty()) {
            mav.addObject("error", "ìˆ™ì†Œ IDê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return mav;
        }

        Map<String, Object> accommodation = adminDao.getAccommodationById(accommodationId.trim());
        List<Map<String, Object>> roomList = adminDao.getRoomsByAccommodationId(accommodationId.trim());

        if (accommodation == null || accommodation.isEmpty()) {
            mav.addObject("error", "í•´ë‹¹ ìˆ™ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            if (!accommodation.containsKey("accommodation_id")) {
                accommodation.put("accommodation_id", accommodation.get("ACCOMMODATION_ID"));
            }
            mav.addObject("accommodation", accommodation);
        }

        mav.addObject("rooms", roomList);


        return mav;
    }        
    
    // âœ… ìˆ™ì†Œ ìŠ¹ì¸ ì²˜ë¦¬
    @RequestMapping("/admin/approveAccommodation.html")
    public String approveAccommodation(
            @RequestParam("accommodationId") String accommodationId,
            RedirectAttributes redirectAttributes) {

        try {
            int result = adminDao.updateAccommodationStatus(accommodationId, 1); // app_status = 1 (ìŠ¹ì¸ ì²˜ë¦¬)
            
            if (result > 0) {
                redirectAttributes.addFlashAttribute("message", "ìˆ™ì†Œ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                return "redirect:/admin/approvalSuccess.html";  // ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™
            } else {
                redirectAttributes.addFlashAttribute("error", "ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return "redirect:/admin/adminPendingAcc.html";
            }
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
            return "redirect:/admin/adminPendingAcc.html";
        }
    }

    // âœ… ìŠ¹ì¸ ì„±ê³µ í˜ì´ì§€
    @RequestMapping("/admin/approvalSuccess.html")
    public ModelAndView approvalSuccess() {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "approvalSuccess.jsp");
        return mav;
    }
}