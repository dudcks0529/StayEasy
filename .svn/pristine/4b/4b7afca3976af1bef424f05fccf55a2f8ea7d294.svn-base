package controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import dao.AdminDao;
import dao.InquireDao;
import dao.MyInformationDao;
import model.Inquire;
import model.LoginUser;
import model.Reservation;
import model.StartEnd;
import model.UserInfo;

@Controller
public class AdminController {
    
    @Autowired
    private AdminDao adminDao;
    @Autowired
    private MyInformationDao myinformationDao;
    @Autowired
    private InquireDao inquireDao;
    
    @RequestMapping("/admin/userInqList.html")
    public ModelAndView userInqList(HttpSession session, String userId, Integer pageNo) {
    	ModelAndView mav = new ModelAndView("main");
    	LoginUser loginUser = (LoginUser)session.getAttribute("loginUser");
    	//ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
        if (loginUser == null || !"admin".equals(loginUser.getId())) {
            mav.addObject("BODY","login.jsp");
            mav.addObject(new LoginUser());
            return mav;
        }

    	int currentPage = 1;
    	if(pageNo != null) currentPage = pageNo;
    	int start =(currentPage-1) * 4;
    	int end = ((currentPage-1)*4)+5;
    	StartEnd se = new StartEnd();se.setStart(start);se.setEnd(end); se.setUserId(userId);  // ğŸ”¥ ì¶”ê°€: í˜„ì¬ ë¡œê·¸ì¸í•œ user_idë¥¼ í•„í„°ë§ ì¡°ê±´ìœ¼ë¡œ ì „ë‹¬
    	List<Inquire> inquireList;
        if ("admin".equals(userId)) {
            // ğŸ”¥ adminì€ ëª¨ë“  ë¬¸ì˜ ì¡°íšŒ
            inquireList = this.inquireDao.getInquireList(se);
        } else {
            // ğŸ”¥ ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ ë¬¸ì˜ + adminì´ ì‘ì„±í•œ ë¬¸ì˜ë§Œ ì¡°íšŒ
            inquireList = this.inquireDao.getInquireListByUser(se);
        }
        int totalCount = "admin".equals(userId) ? this.inquireDao.getInquireCountAll() : this.inquireDao.getInquireCountUser(userId);
    	int pageCount = totalCount/4;
    	if(totalCount %4 !=0) pageCount++;
    	mav.addObject("currentPage",currentPage);
    	mav.addObject("PAGES",pageCount);
    	mav.addObject("BODY","inquireList.jsp");
    	mav.addObject("INQUIRE",inquireList);
    	return mav;
    }
    
    @RequestMapping("/admin/userReservList.html") //ì‚¬ìš©ì ì¡°íšŒ -> ì‚¬ìš©ì ì˜ˆì•½ëª©ë¡ ë¦¬ìŠ¤íŠ¸
    public ModelAndView userReservList(HttpSession session, String userId) {
    	ModelAndView mav = new ModelAndView("main");
    	LoginUser loginUser = (LoginUser)session.getAttribute("loginUser");
    	//ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
        if (loginUser == null || !"admin".equals(loginUser.getId())) {
            mav.addObject("BODY","login.jsp");
            mav.addObject(new LoginUser());
            return mav;
        }
        //ì‚¬ìš©ìì˜ ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸
        List<Reservation> reservList = this.myinformationDao.getReservList(userId);
        mav.addObject("reservList", reservList);
    	mav.addObject("BODY", "mypageAccList.jsp");
    	return mav;
    }
    
    // âœ… ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ì´ë™
    @RequestMapping("/admin/adminUserManagement.html")
    public ModelAndView userManagement() {
        ModelAndView mav = new ModelAndView("main"); 
        mav.addObject("BODY", "adminUserManagement.jsp"); // BODYì— adminUserManagement.jsp ì„¤ì •
        return mav;
    }

    // âœ… ì‚¬ìš©ì ì¡°íšŒ í˜ì´ì§€ (í˜ì´ì§€ ì´ë™ ë° ì¡°íšŒ ê²°ê³¼ ì²˜ë¦¬)
    @RequestMapping("/admin/viewUserInfo.html")
    public ModelAndView viewUserInfo(@RequestParam(value = "user_id", required = false) String user_id) {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "adminViewUserInfo.jsp");

        if (user_id != null && !user_id.trim().isEmpty()) {
            UserInfo userInfo = adminDao.getUserInfoById(user_id.trim()); // DB ì¡°íšŒ
            
            if (userInfo != null) {
                mav.addObject("userInfo", userInfo); // ì¡°íšŒëœ ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
            } else {
                mav.addObject("error", "í•´ë‹¹ ì•„ì´ë””ì˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
                mav.addObject("BODY", "adminUserManagement.jsp");
            }
        } else {
            mav.addObject("error", "ì‚¬ìš©ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            mav.addObject("BODY", "adminUserManagement.jsp");
        }

        return mav;
    }
    
 // âœ… ìŠ¹ì¸ ëŒ€ê¸° ìˆ™ì†Œ ëª©ë¡ (app_status = 0ì¸ ìˆ™ì†Œë§Œ ì¡°íšŒ)
    @RequestMapping("/admin/adminPendingAcc.html")
    public ModelAndView pendingAccommodations() {
        ModelAndView mav = new ModelAndView("main");
        mav.addObject("BODY", "adminPendingAcc.jsp");

        List<Map<String, Object>> accommodations = adminDao.getPendingAccommodations();

        // ì‚¬ìš©ì ì •ë³´ ì¶”ê°€ ë¡œì§
        List<Map<String, Object>> accommodationsWithUserInfo = new ArrayList<>();
        for (Map<String, Object> acc : accommodations) {
            Map<String, Object> accData = new HashMap<>();
            accData.put("accname", acc.get("accname"));
            accData.put("location", acc.get("location"));
            accData.put("app_status", acc.get("app_status"));

            // ì¶”ê°€ëœ ë°ì´í„° ë§¤í•‘
            accData.put("username", acc.get("username") != null ? acc.get("username") : "N/A");
            accData.put("phone", acc.get("phone") != null ? acc.get("phone") : "N/A");

            accommodationsWithUserInfo.add(accData);
        }

        mav.addObject("pendingAccommodations", accommodationsWithUserInfo);

        return mav;
    }

    // âœ… ìˆ™ì†Œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
    @RequestMapping("/admin/viewAccommodationDetail.html")
    public ModelAndView viewAccommodationDetail(@RequestParam("accommodationId") String accommodationId) {
        ModelAndView mav = new ModelAndView("main");  
        mav.addObject("BODY", "approveAccommodation.jsp");  // ğŸ”„ JSP ê²½ë¡œ ìˆ˜ì •

     // ìˆ™ì†Œ ì •ë³´ ì¡°íšŒ
        Map<String, Object> accommodation = adminDao.getAccommodationById(accommodationId);
        List<Map<String, Object>> roomList = adminDao.getRoomsByAccommodationId(accommodationId);

        // JSPì— ë§ê²Œ ë°ì´í„° ë°”ì¸ë”©
        mav.addObject("accommodation", accommodation);
        mav.addObject("rooms", roomList);

        return mav;
    }

    // âœ… ìˆ™ì†Œ ìŠ¹ì¸ ì²˜ë¦¬
    @RequestMapping("/admin/approveAccommodation.html")
    public String approveAccommodation(
            @RequestParam("accommodationId") String accommodationId,
            RedirectAttributes redirectAttributes) {

        try {
            int result = adminDao.updateAccommodationStatus(accommodationId, 1); // ìŠ¹ì¸ ì²˜ë¦¬
            if (result > 0) {
                redirectAttributes.addFlashAttribute("message", "ìˆ™ì†Œ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                redirectAttributes.addFlashAttribute("error", "ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
        }

        return "redirect:/admin/adminPendingAcc.html";
    }
}