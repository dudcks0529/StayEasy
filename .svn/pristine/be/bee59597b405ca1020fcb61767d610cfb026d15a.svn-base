	package controller;
	
	import java.util.List;
	
	import javax.servlet.http.HttpSession;
	import javax.validation.Valid;
	
	import org.springframework.beans.factory.annotation.Autowired;
	import org.springframework.stereotype.Controller;
	import org.springframework.validation.BindingResult;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RequestMethod;
	import org.springframework.web.bind.annotation.RequestParam;
	import org.springframework.web.servlet.ModelAndView;
	
	import dao.AccDao;
	import dao.InquireDao;
	import model.Event;
	import model.Inquire;
	import model.LoginUser;
	import model.Reservation;
	import model.StartEnd;
	import model.User;
	
	
	@Controller
	public class InquireController {
		
	    @Autowired
	    private InquireDao inquireDao;
	    @Autowired 
	    private AccDao accDao;
	    
	    
	    @RequestMapping(value="/inquire/inquireReply.html")
	    public ModelAndView reply(Integer inquire_id, Integer parent_id, Integer group_id, String status) {
	    	ModelAndView mav = new ModelAndView("main");
	    	Inquire inquire = this.inquireDao.getInquireDetail(inquire_id);
	    	String reserv_id = this.inquireDao.getReservId(inquire_id);
	    	
	    	Reservation reservation = new Reservation();
	        reservation.setReservation_id(reserv_id);
	        inquire.setReservation(reservation);
	        
	        
	    	inquire.setI_date(null); 
	    	inquire.setGroup_id(group_id); inquire.setParent_id(parent_id); inquire.setStatus(status);
	    	mav.addObject("title","RE]"+inquire.getTitle());
	    	mav.addObject("content",inquire.getContent());
	    	mav.addObject("reserv_id",reserv_id);
	    	mav.addObject("BODY","inquireWrite.jsp");
	    	mav.addObject("inquire",inquire);
	    	return mav;
	    }
	    
		@RequestMapping(value="/inquire/modify.html")
		public ModelAndView modify(@Valid Inquire inquire, BindingResult br, String BTN, Integer event_id, HttpSession session) {
		    ModelAndView mav = new ModelAndView("main");
		    if (br.hasErrors()) {
		        mav.addObject("BODY", "inquireDetailOwner.jsp");
		        mav.getModel().putAll(br.getModel());
		        return mav;
		    }
	
		    if (BTN.equals("ì‚­ ì œ")) {
		        this.inquireDao.deleteInquire(inquire.getInquire_id());
		        mav.addObject("BODY", "inquireDeleteResult.jsp");
		    } else if (BTN.equals("ìˆ˜ ì •")) {
		        this.inquireDao.updateInquire(inquire);
		        mav.addObject("inquire",inquire);
		        mav.addObject("BODY", "inquireUpdateResult.jsp");
	    
		    }
	
		    return mav;
		}
	    
		@RequestMapping(value="/inquire/inquireWrite.html", method=RequestMethod.GET)
	    public ModelAndView writeform(HttpSession session) {
	        ModelAndView mav = new ModelAndView("main");
	        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
	        LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
	        if (loginUser == null) {
	            mav.addObject("BODY", "login.jsp");
	            return mav;
	        }
	
	        // ê°€ì¥ ìµœê·¼ ì˜ˆì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
	        Reservation reservation = accDao.getLatestReservation(loginUser.getId());
	
	        // ë¬¸ì˜ ê°ì²´ ìƒì„± ë° ì‚¬ìš©ì, ì˜ˆì•½ ì •ë³´ ì„¤ì •
	        Inquire inquire = new Inquire();
	        inquire.setUser(new User());
	        inquire.getUser().setUser_id(loginUser.getId());
	        inquire.setReservation(reservation);
	        inquire.setOrder_no(0);
	        inquire.setGroup_id(0);
	        inquire.setParent_id(0);
	        
	        Integer inq_id = this.inquireDao.countInqId();
	        System.out.println("inq_id : " + inq_id);
	        if(inq_id == null || inq_id == 0) {
	        	inq_id = 1;
	        } else {
	        	inq_id +=1;
	        }
	    	inquire.setInquire_id(inq_id);
	        String reserv_id = "";
	        if (reservation != null) {
	            reserv_id = reservation.getReservation_id(); // â­ ì´ê²Œ ì •ë‹µ
	        }
	        
	        mav.addObject("reserv_id",reserv_id);
	        mav.addObject("inquire", inquire);
	        mav.addObject("BODY", "inquireWrite.jsp");
	        return mav;
	    }
		@RequestMapping(value="/inquire/write.html", method=RequestMethod.POST)
		public ModelAndView write(@Valid Inquire inquire, BindingResult br, HttpSession session) {
		    ModelAndView mav = new ModelAndView("main");
		    System.out.println("ì˜ˆì•½ë²ˆí˜¸ ë””ë²„ê¹…: " + inquire.getReservation()); // nullì´ë©´ ë¬¸ì œ
		    System.out.println("ì˜ˆì•½ë²ˆí˜¸ ë””ë²„ê¹… (id): " + (inquire.getReservation() != null ? inquire.getReservation().getReservation_id() : "NULL")); // null ì²´í¬
		    System.out.println("ë¬¸ì˜ë²ˆí˜¸ "+inquire.getInquire_id());
		    // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ
		    
		    if (br.hasErrors()) {
		        mav.addObject("BODY", "inquireWrite.jsp");
		        mav.getModel().putAll(br.getModel());
		        return mav;
		    }
	
		    // ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸
		    LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
		    if (loginUser == null) {
		        mav.addObject("BODY", "login.jsp");
		        return mav;
		    }
	
		    // ì‘ì„±ì ì •ë³´ ì„¸íŒ…
		    inquire.setUser(new User());
		    inquire.getUser().setUser_id(loginUser.getId());
	
		    // ì˜ˆì•½ ì •ë³´ ì„¤ì •
		    Reservation reservation = null;
	
		    if (inquire.getParent_id() != null && inquire.getParent_id() > 0) { // âœ… ë‹µë³€ ê¸€ì¸ ê²½ìš°
		        Inquire parentInquire = this.inquireDao.getInquireDetail(inquire.getParent_id());
		        if (parentInquire != null) {
		            reservation = parentInquire.getReservation(); // ë¶€ëª¨ ë¬¸ì˜ì˜ ì˜ˆì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
		        }
		    } else { // âœ… ì›ê¸€ì¸ ê²½ìš°
		        reservation = accDao.getLatestReservation(loginUser.getId()); // ë³¸ì¸ ìµœì‹  ì˜ˆì•½ ì •ë³´
		    }
	
		    // ì˜ˆì•½ ì •ë³´ ì—†ì„ ë•Œ ì˜ˆì™¸ ì²˜ë¦¬
		    if (reservation == null) {
		        mav.addObject("errorMessage", "ìµœê·¼ ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ˆì•½ í›„ ë¬¸ì˜ë¥¼ ë“±ë¡í•˜ì„¸ìš”.");
		        mav.addObject("BODY", "inquireWrite.jsp");
		        return mav;
		    }
	
		    // ì˜ˆì•½ ì •ë³´ ì„¸íŒ…
		    inquire.setReservation(reservation);
	
		    // ìƒˆë¡œìš´ ë¬¸ì˜ ID ì„¤ì • (maxNum)
		    Integer maxNum = this.inquireDao.getMaxNum()+1;
	
		    // ê·¸ë£¹ ID ë° ë‹µë³€/ì›ê¸€ êµ¬ë¶„
		    if (inquire.getParent_id() == null || inquire.getParent_id() == 0) { // ì›ê¸€
		        inquire.setParent_id(0);
		        inquire.setOrder_no(0);
		        inquire.setGroup_id(maxNum);
		    } else { // ë‹µê¸€
		        this.inquireDao.updateOrderNo(inquire);
		    }
	
		    // ê¸°íƒ€ ì •ë³´ ì„¸íŒ…
		    inquire.setInquire_id(maxNum);
		    inquire.setStatus("ëŒ€ê¸°");
	
		    // ìµœì¢… ì €ì¥
		    this.inquireDao.putInquire(inquire);
		    
		    // ê²°ê³¼ í˜ì´ì§€ ì´ë™
		    mav.addObject("BODY", "inquireWriteResult.jsp");
		    return mav;
		}
	
	
	    /**
	     * ë¬¸ì˜ ë‚´ìš©ì„ ì‹¤ì œ DBì— ì €ì¥í•˜ëŠ” ë©”ì†Œë“œ (POST)
	     */
	   
	    @RequestMapping(value="/inquire/inquireList.html")
	    public ModelAndView list(HttpSession session, Integer pageNo) {
	    	ModelAndView mav = new ModelAndView("main");
	        LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
	        if (loginUser == null) {
	            mav.addObject("BODY", "login.jsp");
	            return mav;
	        }
	        String userId = loginUser.getId(); // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID
	        
	    	int currentPage = 1;
	    	if(pageNo != null) currentPage = pageNo;
	    	int start =(currentPage-1) * 4;
	    	int end = ((currentPage-1)*4)+5;
	    	StartEnd se = new StartEnd();se.setStart(start);se.setEnd(end); se.setUserId(userId);  // ğŸ”¥ ì¶”ê°€: í˜„ì¬ ë¡œê·¸ì¸í•œ user_idë¥¼ í•„í„°ë§ ì¡°ê±´ìœ¼ë¡œ ì „ë‹¬
	    	List<Inquire> inquireList;
	        if ("admin".equals(userId)) {
	            // ğŸ”¥ adminì€ ëª¨ë“  ë¬¸ì˜ ì¡°íšŒ
	            inquireList = this.inquireDao.getInquireList(se);
	        } else {
	            // ğŸ”¥ ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ ë¬¸ì˜ + adminì´ ì‘ì„±í•œ ë¬¸ì˜ë§Œ ì¡°íšŒ
	            inquireList = this.inquireDao.getInquireListByUser(se);
	        }
	        int totalCount = "admin".equals(userId) ? this.inquireDao.getInquireCountAll() : this.inquireDao.getInquireCountUser(userId);
	    	int pageCount = totalCount/4;
	    	if(totalCount %4 !=0) pageCount++;
	    	mav.addObject("currentPage",currentPage);
	    	mav.addObject("PAGES",pageCount);
	    	mav.addObject("BODY","inquire.jsp");
	    	mav.addObject("INQUIRE",inquireList);
	    	return mav;
	    }
	
		@RequestMapping(value="/inquire/detail.html")
		public ModelAndView readinquire(Integer inquire_id, HttpSession session) {
	
			ModelAndView mav = new ModelAndView("main");
			Inquire inquire = this.inquireDao.getInquireDetail(inquire_id);
			LoginUser user = (LoginUser)session.getAttribute("loginUser");
			mav.addObject("inquire",inquire);
		        if (user != null && user.getId().equals("admin")) {
		            mav.addObject("BODY", "inquireDetailAdmin.jsp");
		        } else {
		            mav.addObject("BODY", "inquireDetailOwner.jsp");
		        } 
	
		    return mav;
		}
	
	
	}