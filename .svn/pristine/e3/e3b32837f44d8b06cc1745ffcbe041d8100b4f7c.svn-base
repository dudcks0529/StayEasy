package controller;

import java.util.List;

import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

import dao.AccDao;
import dao.CartDao;
import model.Accommodation;
import model.CartItem;
import model.LoginUser;
import model.Reservation;
import model.Room;
import model.User;

@Controller
public class CartController {
	
	@Autowired
	private AccDao accDao;
	@Autowired
	private CartDao cartDao;
	
	@RequestMapping(value="/cart/cartList.html")
	public ModelAndView cartList(HttpSession session) {
		ModelAndView mav = new ModelAndView("main");
		LoginUser user = (LoginUser)session.getAttribute("loginUser");
		if(user == null) {
			mav.addObject(new LoginUser());
			mav.addObject("BODY","login.jsp");
			return mav;
		}
		List<CartItem> cartList = this.cartDao.selectCartItem(user.getId());
		String room_id = "";
		for(CartItem item : cartList) {
		    if (item.getRoom() == null) {
		        System.out.println("ğŸš¨ Room ê°ì²´ê°€ NULLì…ë‹ˆë‹¤! CartItem ID: " + item.getCartitem_id());
		    } else {
		        System.out.println("âœ… Room ID: " + item.getRoom().getId().getRoomId());
		    }
		}

		mav.addObject("cartList",cartList);
		mav.addObject("BODY","cartList.jsp");
		return mav;
	}

	@RequestMapping(value="/cart/addCart.html") //ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
	public ModelAndView addCart(@Valid Reservation reservation, BindingResult br,
			HttpSession session, String accId, String roomId) {
		ModelAndView mav = new ModelAndView("main");
		LoginUser user = (LoginUser)session.getAttribute("loginUser");
		//ë¡œê·¸ì¸ì„ ì•ˆ í•œ ê²½ìš°, ë¡œê·¸ì¸ ì°½ì„ ë„ìš´ë‹¤.
		if(user == null) {
			mav.addObject(new LoginUser());
			mav.addObject("BODY","login.jsp");
			return mav;
		}
		else { //ë¡œê·¸ì¸ì„ í•œ ê²½ìš°
			
		//í¼ ì²´í¬ ì§„í–‰ì‹œ ê°ì²´ ìœ ì§€
		Accommodation acc = this.accDao.getAccDetail(accId);
		List<Room> list = this.accDao.getRoomId(accId);
		Room room = this.accDao.getRoomDetail(accId, roomId);
		mav.addObject("roomInfo",room);
		mav.addObject("reservation", reservation);
		mav.addObject("ACC",acc);
		mav.addObject("RoomList", list);
		//ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•œ í¼ì²´í¬
		if(br.hasErrors()) {
			mav.addObject("BODY","accDetail.jsp");
			mav.getModel().putAll(br.getModel());
			return mav;
		}
		
		//ì´ ê³„ì‚°ê¸ˆì•¡ ì„¤ì •
		int total_price =  room.getPrice_per_night() * reservation.getCount();
		reservation.setTotal_price(total_price);
		reservation.setRoom(room);
		
		//ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
		CartItem cartItem = new CartItem();
		Integer num = this.cartDao.getMaxCartId();
		if(num == null) {
			num = 1;
		}else {
			num += 1;
		}
		String maxNum = Integer.toString(num);
		cartItem.setCartitem_id(maxNum);
		User uuser = this.accDao.getUserId(user.getId());
		//dbì— ì¥ë°”êµ¬ë‹ˆ í•­ëª© ì‚½ì…
		this.cartDao.insertCartItem(cartItem, reservation, uuser);
		mav.addObject("BODY","addCartResult.jsp");
		return mav;
		}
	}
}
