package controller;

import java.util.List;

import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import dao.AccDao;
import dao.InquireDao;
import model.Inquire;
import model.LoginUser;
import model.Reservation;
import model.StartEnd;
import model.User;


@Controller
public class InquireController {
	
    @Autowired
    private InquireDao inquireDao;
    @Autowired 
    private AccDao accDao;
    @RequestMapping(value="/inquire/inquireWrite.html", method=RequestMethod.GET)
    public ModelAndView writeform(HttpSession session) {
        ModelAndView mav = new ModelAndView("main");
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
        if (loginUser == null) {
            mav.addObject("BODY", "login.jsp");
            return mav;
        }

        // ê°€ì¥ ìµœê·¼ ì˜ˆì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        Reservation reservation = accDao.getLatestReservation(loginUser.getId());

        // ë¬¸ì˜ ê°ì²´ ìƒì„± ë° ì‚¬ìš©ì, ì˜ˆì•½ ì •ë³´ ì„¤ì •
        Inquire inquire = new Inquire();
        inquire.setUser(new User());
        inquire.getUser().setUser_id(loginUser.getId());
        inquire.setReservation(reservation);

        mav.addObject("inquire", inquire);
        mav.addObject("BODY", "inquireWrite.jsp");
        return mav;
    }

    /**
     * ë¬¸ì˜ ë‚´ìš©ì„ ì‹¤ì œ DBì— ì €ì¥í•˜ëŠ” ë©”ì†Œë“œ (POST)
     */
    @RequestMapping(value="/inquire/write.html", method=RequestMethod.POST)
    public ModelAndView write(@Valid Inquire inquire, BindingResult br, HttpSession session) {
        ModelAndView mav = new ModelAndView("main");

        // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ í¼ì„ ë³´ì—¬ì¤Œ
        if (br.hasErrors()) {
            mav.addObject("BODY", "inquireWrite.jsp");
            mav.getModel().putAll(br.getModel());
            return mav;
        }

        // ë¡œê·¸ì¸ í™•ì¸
        LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
        if (loginUser == null) {
            mav.addObject("BODY", "login.jsp");
            return mav;
        }

        // ê°€ì¥ ìµœê·¼ ì˜ˆì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        Reservation reservation = accDao.getLatestReservation(loginUser.getId());
        
        // ì‚¬ìš©ì ë° ì˜ˆì•½ ì •ë³´ ì„¤ì •
        inquire.setUser(new User());
        inquire.getUser().setUser_id(loginUser.getId());
        inquire.setReservation(reservation);
        
        // ìƒˆë¡œìš´ ë¬¸ì˜ ID ì„¤ì •
        int inquire_id = this.inquireDao.getMaxNum() + 1;
        inquire.setInquire_id(inquire_id);
        inquire.setStatus("ëŒ€ê¸°"); // ìƒíƒœë¥¼ ê¸°ë³¸ê°’ì¸ 'ëŒ€ê¸°'ë¡œ ì„¤ì •

        // ë¬¸ì˜ ì €ì¥
        this.inquireDao.putInquire(inquire);

        mav.addObject("BODY", "inquireWriteResult.jsp");
        return mav;
    }
    
    @RequestMapping(value="/inquire/inquireList.html")
    public ModelAndView list(HttpSession session, Integer pageNo) {
    	ModelAndView mav = new ModelAndView("main");
        LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
        if (loginUser == null) {
            mav.addObject("BODY", "login.jsp");
            return mav;
        }
        String userId = loginUser.getId(); // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID
        
    	int currentPage = 1;
    	if(pageNo != null) currentPage = pageNo;
    	int start =(currentPage-1) * 4;
    	int end = ((currentPage-1)*4)+5;
    	StartEnd se = new StartEnd();se.setStart(start);se.setEnd(end); se.setUserId(userId);  // ğŸ”¥ ì¶”ê°€: í˜„ì¬ ë¡œê·¸ì¸í•œ user_idë¥¼ í•„í„°ë§ ì¡°ê±´ìœ¼ë¡œ ì „ë‹¬
    	List<Inquire> inquireList;
        if ("admin".equals(userId)) {
            // ğŸ”¥ adminì€ ëª¨ë“  ë¬¸ì˜ ì¡°íšŒ
            inquireList = this.inquireDao.getInquireList(se);
        } else {
            // ğŸ”¥ ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ ë¬¸ì˜ + adminì´ ì‘ì„±í•œ ë¬¸ì˜ë§Œ ì¡°íšŒ
            inquireList = this.inquireDao.getInquireListByUser(se);
        }
        int totalCount = this.inquireDao.getInquireCount();
    	int pageCount = totalCount/4;
    	if(totalCount %4 !=0) pageCount++;
    	mav.addObject("currentPage",currentPage);
    	mav.addObject("PAGES",pageCount);
    	mav.addObject("BODY","inquire.jsp");
    	mav.addObject("INQUIRE",inquireList);
    	return mav;
    }

	@RequestMapping(value="/inquire/detail.html")
	public ModelAndView readinquire(Integer inquire_id, HttpSession session) {

		ModelAndView mav = new ModelAndView("main");
		Inquire inquire = this.inquireDao.getInquireDetail(inquire_id);
		LoginUser user = (LoginUser)session.getAttribute("loginUser");
		mav.addObject(inquire);
	        if (user != null && user.getId().equals(inquire.getUser().getUser_id())) {
	            mav.addObject("BODY", "inquireDetailOwner.jsp");
	        } else if (user != null && user.getId().equals("admin")) { // ê´€ë¦¬ìì¸ ê²½ìš°
	            mav.addObject("BODY", "inquireDetailAdmin.jsp");
	        } 
	    
	    mav.addObject("INQUIRE", inquire);
	    return mav;
	}
		
}