package controller;

import java.math.BigDecimal;
import java.util.List;

import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

import dao.ReviewDao;
import model.LoginUser;
import model.Reservation;
import model.Review;
import model.User;

@Controller
public class ReviewController {
	
	@Autowired
	private ReviewDao reviewDao;
	
	@RequestMapping(value="/review/delete.html")
	public ModelAndView delete(Integer review_id, String ACC, HttpSession session) {
		ModelAndView mav = new ModelAndView("main");
		LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");
		// ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
		if (loginUser == null) {
			mav.addObject("BODY", "login.jsp");
			mav.addObject(new LoginUser());
			return mav;
		}
		this.reviewDao.deleteReview(review_id);
		mav.addObject("BODY", "reviewDeleteResult.jsp");
		mav.addObject("ACC", ACC);
		return mav;
	}
	
	@RequestMapping(value="/review/input.html")
	public ModelAndView input(@Valid Review review, BindingResult br,
	                HttpSession session, String ACC) {
	    ModelAndView mav = new ModelAndView("main");

	    // ğŸ” ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (ì…ë ¥ë°›ì€ ê°’ í™•ì¸)
	    System.out.println("ğŸš¨ ì›ë³¸ Review Reservation ID: " + (review.getReservation() != null ? review.getReservation().getReservation_id() : "NULL"));

	    if (br.hasErrors()) {
	        mav.addObject("BODY", "reviewWrite.jsp");
	        mav.getModel().putAll(br.getModel());
	        return mav;
	    }

	    // ë¦¬ë·° ID ì„¤ì •
	    int review_id = this.reviewDao.getMaxNum() + 1;
	    review.setReview_id(review_id);

	    // â­ ì„¸ì…˜ì—ì„œ ë¡œê·¸ì¸ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
	    LoginUser loginUser = (LoginUser) session.getAttribute("loginUser");

	    if (loginUser != null) {
	        User user = new User();
	        user.setUser_id(loginUser.getId());
	        review.setUser(user);
	    } else {
	        System.out.println("ğŸš¨ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ê°€ ì—†ìŒ!");
	        mav.addObject("BODY", "login.jsp");
	        mav.addObject(new LoginUser());
	        return mav;
	    }

	    // ğŸš¨ reservation_idê°€ NULLì´ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì˜ˆì™¸ ì²˜ë¦¬
	    if (review.getReservation() == null || review.getReservation().getReservation_id() == null || review.getReservation().getReservation_id().trim().isEmpty()) {
	        System.out.println("ğŸš¨ ì˜¤ë¥˜: ìœ íš¨í•˜ì§€ ì•Šì€ reservation_id!");
	        mav.addObject("BODY", "reviewWrite.jsp");
	        return mav;
	    }

	    // ğŸ”¹ ì‰¼í‘œ(`,`)ê°€ ì•ì— ë¶™ì–´ ìˆëŠ” ê²½ìš° ì œê±°
	    String reservationId = review.getReservation().getReservation_id().trim();
	    reservationId = reservationId.replaceAll("^,+", ""); // ì‰¼í‘œ ì—°ì† ì œê±°
	    review.getReservation().setReservation_id(reservationId);

	    // ğŸ” ìˆ˜ì •ëœ reservation_id í™•ì¸
	    System.out.println("âœ… ìˆ˜ì •ëœ Review Reservation ID: " + review.getReservation().getReservation_id());

	    // ë¦¬ë·° ì €ì¥
	    this.reviewDao.putReview(review);
	    mav.addObject("ACC", ACC);
	    mav.addObject("BODY", "reviewInputResult.jsp");
	    return mav;
	}

	
	@RequestMapping(value="/review/write.html")
	public ModelAndView write(HttpSession session, String ACC) {
		ModelAndView mav = new ModelAndView("main");
		LoginUser user = (LoginUser)session.getAttribute("loginUser");	
		//ë¡œê·¸ì¸ì„ ì•ˆ í•œ ê²½ìš°, ë¡œê·¸ì¸ ì°½ì„ ë„ìš´ë‹¤.
		if(user == null) {
			mav.addObject(new LoginUser());
			mav.addObject("BODY","login.jsp");
			return mav;
		}
		else {//ë¡œê·¸ì¸ì„ í•œ ê²½ìš°
			String accname = this.reviewDao.getACCName(ACC);
			String ID = user.getId();
			
			List<Reservation> reservList = this.reviewDao.getReservByUser(user.getId(), ACC);
			
			// âœ… ì˜ˆì•½ ë‚´ì—­ì´ ì—†ì„ ê²½ìš° noReview.jspë¡œ ì´ë™
		    if (reservList == null || reservList.isEmpty()) {
		        mav.addObject("ACC", ACC); // ë¦¬ë·° ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ í•„ìš”
		        mav.addObject("BODY", "noReview.jsp");
		        return mav;
		    }
		    
			mav.addObject(new Review());
			mav.addObject("reservList", reservList);
			mav.addObject("accname", accname);
			mav.addObject("ID", ID);
			mav.addObject("ACC", ACC);
			mav.addObject("BODY", "reviewWrite.jsp");
			return mav;
		}
	}
	
	@RequestMapping(value="/review/list.html")
	public ModelAndView list(String ACC) {
		ModelAndView mav = new ModelAndView("main");
		//ë³„ì 
		BigDecimal ratingAVG = this.reviewDao.getRatingAVG(ACC);
		
		//ìˆ™ì†Œ ì´ë¦„
		String accname = this.reviewDao.getACCName(ACC);
		
		//ì˜ˆì•½ ì •ë³´
		List<Reservation> reservations = this.reviewDao.getReservByAcc(ACC);
		
		// ê° ì˜ˆì•½ì— ëŒ€í•œ ë¦¬ë·° ì¡°íšŒ ë° Room ì •ë³´ ì£¼ì…
        for (Reservation reservation : reservations) {
        	if(reservation == null) continue; //null ì²´í¬
        	
            List<Review> reviews = reviewDao.getReviewByReserv(reservation.getReservation_id());
            reservation.setReview(reviews);
        }
		
        mav.addObject("ACC", ACC);
		mav.addObject("reservations", reservations);
		mav.addObject("rating", ratingAVG);
		mav.addObject("accname", accname);
		mav.addObject("BODY", "reviewList.jsp");
		return mav;
	}
}
